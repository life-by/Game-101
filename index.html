<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶™‡¶æ‡¶ú‡¶≤ - ‡¶Æ‡¶®‡¶∏‡ßç‡¶ü‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶Æ‡¶∞‡¶ø</title>
  <style>
    * { box-sizing: border-box; padding: 0; margin: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, #fceabb, #f8b500);
      display: flex; flex-direction: column; align-items: center;
      padding: 10px; min-height: 100vh; overflow-x: hidden; color: #333;
    }
    h1 {
      margin: 10px 0 15px 0; font-size: 2.5rem; color: #2c3e50;
      text-align: center;
      animation: float 2s ease-in-out infinite alternate; text-shadow: 2px 2px 5px rgba(0,0,0,0.1);
    }
    @keyframes float { 0% { transform: translateY(0); } 100% { transform: translateY(-5px); } }
    #homepage-content {
        display: none; flex-direction: column; align-items: center; background-color: rgba(255, 255, 255, 0.98);
        padding: 40px 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        max-width: 650px; width: 100%; margin: auto; animation: fadeIn 0.8s ease-out; border: 1px solid #ddd;
    }
    #homepage-content.show { display: flex; }
    #mode-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; }
    #mode-selection button, #online-mode-selection button, #online-difficulty-selection button {
        padding: 20px 40px; border: none; border-radius: 30px; background: linear-gradient(to right, #3498db, #2980b9);
        color: white; font-size: 1.4rem; font-weight: bold; box-shadow: 0 6px 18px rgba(0,0,0,0.3);
        cursor: pointer; transition: all 0.3s ease; min-width: 250px; text-align: center;
    }
    #mode-selection button:hover, #online-mode-selection button:hover, #online-difficulty-selection button:hover { transform: translateY(-6px); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
    #super-ultra-btn { background: linear-gradient(to right, #e74c3c, #c0392b); }
    #online-difficulty-selection button { font-size: 1.2rem; min-width: 150px; padding: 15px 30px; }
    
    #game-area {
        display: none; flex-direction: column; align-items: center; width: 100%; max-width: 500px;
        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        padding: 15px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.25);
        margin-top: 10px; border: 1px solid #cce7ee;
    }
    #game-area.show { display: flex; animation: fadeIn 0.8s ease-out; }
    
    .player-info-container {
      display: flex; align-items: center; justify-content: space-between; width: 100%;
      background: rgba(255, 255, 255, 0.7); padding: 10px 15px; border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.9);
    }
    #player1-info { margin-bottom: 15px; }
    #player2-info { margin-top: 15px; }
    .score-area { font-weight: bold; text-align: left; border: none; transition: transform 0.3s ease; }
    .score-area.active-player { transform: scale(1.05); }
    .score-area span { font-size: 1rem; color: #555; }
    .score-area .score-value { font-size: 2rem; display: block; line-height: 1; color: #2c3e50; }
    .power-ups-container { display: flex; gap: 8px; justify-content: flex-end; }
    .power-up-card {
      padding: 8px 12px; border: 2px solid transparent; border-radius: 8px; font-weight: bold;
      cursor: pointer; transition: all 0.2s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      font-size: 0.8rem; background: #fff;
    }
    .power-up-card:hover:not(.disabled) { transform: translateY(-2px) scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
    .power-up-card.disabled { opacity: 0.6; cursor: not-allowed; background-color: #e9ecef; }
    .power-up-card.earned { border-color: #f39c12; background: #f1c40f; color: #fff; }
    .power-up-card.shield-active { border-color: #27ae60; background: #2ecc71; color: white; box-shadow: 0 0 10px #2ecc71; }
    #game-status { display: flex; justify-content: space-around; width: 100%; max-width: 400px; margin: 10px 0; font-size: 0.9rem; }
    #board { display: grid; gap: 5px; justify-content: center; margin: 10px 0; width: 100%; max-width: 400px; }
    .card {
      width: 60px; height: 60px; font-size: 2rem; border-radius: 8px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; transform-style: preserve-3d; transition: transform 0.3s;
      background: #ecf0f1; box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .card .content, .card .back { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; backface-visibility: hidden; }
    .card .content { transform: rotateY(180deg); }
    .card .back { font-size: 1.5rem; }
    .card.flip { transform: rotateY(180deg); background: #ffdd59; }
    .card.matched { visibility: hidden; opacity: 0; transition: visibility 0s 0.4s, opacity 0.4s ease; }
    #message { margin-top: 10px; font-size: 1.2rem; font-weight: bold; text-align: center; min-height: 1.5em; }
    #backButton { margin-top: 15px; padding: 10px 20px; font-size: 0.9rem; display: none; }
    
    .popup-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; visibility: hidden; opacity: 0; transition: visibility 0.3s, opacity 0.3s; }
    .popup-container.show { visibility: visible; opacity: 1; }
    .popup-content { background-color: #fff; padding: 20px 30px; border-radius: 15px; text-align: center; }
    #popup-message { font-size: 1.5rem; margin-bottom: 20px; }
    .popup-buttons button { padding: 10px 20px; font-size: 1rem; margin: 0 10px; cursor: pointer; border-radius: 8px; border: none; }
    #restartBtn { background-color: #28a745; color: white; }
    #newGameBtn { background-color: #3498db; color: white; }
    
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    #board.super-ultra-mode { gap: 4px; max-width: 100%; }
    #board.super-ultra-mode .card { width: 35px; height: 35px; font-size: 1.3rem; }
    
    @media (max-width: 420px) {
        h1 { font-size: 1.8rem; }
        .card { width: 50px; height: 50px; }
        #board.super-ultra-mode .card { width: 30px; height: 30px; font-size: 1rem; }
        .power-up-card { padding: 6px 8px; font-size: 0.7rem; }
        .score-area span { font-size: 0.9rem; }
        .score-area .score-value { font-size: 1.8rem; }
    }
  </style>
</head>
<body>

<h1>‡¶Æ‡¶®‡ßá ‡¶∞‡¶æ‡¶ñ‡¶æ‡¶∞ ‡¶ï‡ßç‡¶∑‡¶Æ‡¶§‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ó‡ßá‡¶Æ</h1>

<div id="homepage-content">
    <div id="mode-selection">
        <button data-rows="4" data-cols="6">‡¶∏‡¶π‡¶ú ‡¶Æ‡ßã‡¶°</button>
        <button data-rows="5" data-cols="6">‡¶Æ‡¶ø‡¶°‡¶ø‡ßü‡¶æ‡¶Æ ‡¶Æ‡ßã‡¶°</button>
        <button data-rows="6" data-cols="6">‡¶ï‡¶†‡¶ø‡¶® ‡¶Æ‡ßã‡¶°</button>
        <button id="super-ultra-btn" data-rows="10" data-cols="10">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶Ü‡¶≤‡¶ü‡ßç‡¶∞‡¶æ ‡¶Æ‡ßã‡¶°</button>
    </div>
    <hr style="width:80%; margin: 20px auto; border-color: #ccc;">
    <div id="online-mode-selection" style="text-align: center; width: 100%;">
        <button id="start-online-btn" style="background: linear-gradient(to right, #1abc9c, #16a085);">‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶Æ‡¶æ‡¶≤‡ßç‡¶ü‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞</button>
    </div>
    <div id="online-connection-area" style="display: none; width: 100%; text-align:center; animation: fadeIn 0.5s;">
        <p>‡¶ï‡ßã‡¶® ‡¶Æ‡ßã‡¶°‡ßá ‡¶ñ‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</p>
        <div id="online-difficulty-selection" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 15px 0;">
            <button data-rows="4" data-cols="6">‡¶∏‡¶π‡¶ú</button>
            <button data-rows="5" data-cols="6">‡¶Æ‡¶ø‡¶°‡¶ø‡ßü‡¶æ‡¶Æ</button>
            <button data-rows="6" data-cols="6">‡¶ï‡¶†‡¶ø‡¶®</button>
        </div>
        <div id="online-code-display" style="font-size: 24px; font-weight: bold; letter-spacing: 4px; color: #2c3e50; margin: 15px 0; min-height: 1.5em;"></div>
        <hr style="width:80%; margin: 20px auto; border-color: #ccc;">
        <input type="text" id="joinCodeInput" placeholder="‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡ß¨-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®" style="padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center; font-size: 1rem;">
        <button id="join-online-btn" style="padding: 10px 15px; background-color: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem;">‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®</button>
        <p id="online-status" style="margin-top: 10px; color: #e67e22;"></p>
    </div>
</div>

<div id="game-area">
    <div id="player1-info" class="player-info-container">
      <div id="player1-score-area" class="score-area">
          <span>‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ 1</span> 
          <span id="player1-score" class="score-value">0</span>
      </div>
      <div class="power-ups-container">
        <div id="p1-penalty-card" class="power-up-card">‚öîÔ∏è ‡¶∂‡¶æ‡¶∏‡ßç‡¶§‡¶ø</div>
        <div id="p1-peek-card" class="power-up-card">üëÅÔ∏è ‡¶â‡¶Å‡¶ï‡¶ø (‡ß´‡ß¶)</div>
        <div id="p1-shield-card" class="power-up-card">üõ°Ô∏è ‡¶∂‡¶ø‡¶≤‡ßç‡¶°</div>
      </div>
    </div>

    <div id="game-status"><div id="game-size"></div><div id="current-player"></div></div>
    <div id="board"></div>

    <div id="player2-info" class="player-info-container">
      <div id="player2-score-area" class="score-area">
          <span>‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ 2</span> 
          <span id="player2-score" class="score-value">0</span>
        </div>
      <div class="power-ups-container">
        <div id="p2-penalty-card" class="power-up-card">‚öîÔ∏è ‡¶∂‡¶æ‡¶∏‡ßç‡¶§‡¶ø</div>
        <div id="p2-peek-card" class="power-up-card">üëÅÔ∏è ‡¶â‡¶Å‡¶ï‡¶ø (‡ß´‡ß¶)</div>
        <div id="p2-shield-card" class="power-up-card">üõ°Ô∏è ‡¶∂‡¶ø‡¶≤‡ßç‡¶°</div>
      </div>
    </div>
    <div id="message"></div>
</div>

<div id="win-popup" class="popup-container">
  <div class="popup-content">
    <div id="popup-message"></div>
     <div class="popup-buttons">
         <button id="restartBtn">‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ñ‡ßá‡¶≤‡ßÅ‡¶®</button>
         <button id="newGameBtn">‡¶®‡¶§‡ßÅ‡¶® ‡¶ó‡ßá‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
     </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>

<script>
// ========= START: COMPLETE JAVASCRIPT CODE =========

// --- START: PASTE YOUR FIREBASE CONFIG HERE ---
const firebaseConfig = {
  apiKey: "AIzaSyCBukPCFS4aNvyNnNChBbhl-287a0Or3JY", // ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßÄ ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶¶‡¶ø‡¶®
  authDomain: "tangim-28d01.firebaseapp.com",
  databaseURL: "https://tangim-28d01-default-rtdb.firebaseio.com",
  projectId: "tangim-28d01",
  storageBucket: "tangim-28d01.appspot.com",
  messagingSenderId: "787567404249",
  appId: "1:787567404249:web:630c0df0f642baaaa50ac8",
  measurementId: "G-4X5SGX4XJZ"
};
// --- END: PASTE YOUR FIREBASE CONFIG HERE ---

// Initialize Firebase
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const db = firebase.database();

const emojis = ["üê∏", "üåµ", "üçï", "üéÆ", "ü¶Ñ", "üê±", "‚öΩ", "üêµ", "üëæ", "üöÄ", "üçâ", "üê∂", "ü¶ñ", "üé≤", "üí©", "üëΩ", "üß†", "üçî", "üåà", "üòà", "ü§ñ", "üëπ", "ü§°", "üëª", "üêß", "ü¶ã", "üçé", "üçä", "üçì", "üçá", "ü•ù", "ü••", "ü•ë", "üçÜ", "ü•ï", "üå∂Ô∏è", "ü•ê", "üç©", "üç≠", "üç¨", "üç´", "üçø", "üéâ", "üéÅ", "üíé", "üí∞", "üí°", "üí£", "üéà", "‚ù§Ô∏è", "üõ°Ô∏è"];
const maxEmojis = emojis.length;

// Game State Variables
let player1Score = 0, player2Score = 0, currentPlayer = 1;
let flipped = [], lockBoard = false;
let currentGameRows = 0, currentGameCols = 0;
let p1_consecutiveMatches = 0, p2_consecutiveMatches = 0;
let p1_penaltyCardUsed = false, p2_penaltyCardUsed = false;
let p1_peekCardUsed = false, p2_peekCardUsed = false;
let p1_shieldUnlocked = false, p2_shieldUnlocked = false;
let p1_shieldActive = false, p2_shieldActive = false;

// Online Mode Variables
let isOnlineMode = false;
let peerConnection;
let dataChannel;
let gameCode;
let isHost = false;
let isMyTurn = false;

// HTML Element References
const homepageContentElement = document.getElementById('homepage-content');
const gameAreaElement = document.getElementById('game-area');
const boardElement = document.getElementById("board");
const messageElement = document.getElementById("message");
const player1ScoreArea = document.getElementById("player1-score-area");
const player2ScoreArea = document.getElementById("player2-score-area");
const player1ScoreElement = document.getElementById("player1-score");
const player2ScoreElement = document.getElementById("player2-score");
const currentPlayerElement = document.getElementById("current-player");
const gameSizeElement = document.getElementById("game-size");
const winPopup = document.getElementById("win-popup");
const p1PenaltyCard = document.getElementById('p1-penalty-card');
const p1PeekCard = document.getElementById('p1-peek-card');
const p2PenaltyCard = document.getElementById('p2-penalty-card');
const p2PeekCard = document.getElementById('p2-peek-card');
const p1ShieldCard = document.getElementById('p1-shield-card');
const p2ShieldCard = document.getElementById('p2-shield-card');
const onlineConnectionArea = document.getElementById('online-connection-area');
const onlineStatusElement = document.getElementById('online-status');
const onlineCodeDisplay = document.getElementById('online-code-display');

// --- Core Game Functions ---

function startGame(rows, cols) {
    isOnlineMode = false;
    hideHomePage();
    hideWinPopup();
    resetGameState(rows, cols);
    buildBoard(rows, cols);
    updateGameInfoDisplay();
    showMessage("‡¶ó‡ßá‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ!", true);
}

function resetGameState(rows, cols) {
    player1Score = 0; player2Score = 0; currentPlayer = 1;
    flipped = []; lockBoard = false;
    messageElement.innerText = "";
    currentGameRows = rows; currentGameCols = cols;
    resetPowerUps();
    boardElement.classList.toggle('super-ultra-mode', rows === 10 && cols === 10);
}

function buildBoard(rows, cols) {
    boardElement.innerHTML = ""; lockBoard = false;
    const gridSizeInfo = getGridSize(rows, cols);
    if (!gridSizeInfo) { showMessage("‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø: ‡¶¨‡ßã‡¶∞‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ø‡¶•‡ßá‡¶∑‡ßç‡¶ü ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶®‡ßá‡¶á‡•§", false); return; }
    const { totalPairs } = gridSizeInfo;
    const requiredEmoji = 'üõ°Ô∏è';
    let otherEmojis = emojis.filter(e => e !== requiredEmoji);
    shuffle(otherEmojis);
    let pairEmojis = otherEmojis.slice(0, totalPairs - 1);
    pairEmojis.push(requiredEmoji);
    let cardsData = shuffle([...pairEmojis, ...pairEmojis]);
    boardElement.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

    cardsData.forEach((emoji, index) => {
        const card = document.createElement("div");
        card.className = "card";
        card.dataset.emoji = emoji;
        card.dataset.index = index;
        card.innerHTML = `<div class="back">?</div><div class="content">${emoji}</div>`;
        card.addEventListener("click", () => handleCardClick(card));
        boardElement.appendChild(card);
    });
}

function handleCardClick(card) {
    if (isOnlineMode && !isMyTurn) return;
    flipCard(card);
}

function flipCard(card, isRemote = false) {
    if (lockBoard || card.classList.contains("flip") || card.classList.contains("matched")) return;
    if (isOnlineMode && !isRemote) { sendData({ type: 'flip', index: card.dataset.index }); }
    card.classList.add("flip");
    flipped.push(card);
    if (flipped.length === 2) { lockBoard = true; checkForMatch(); }
}

function checkForMatch() {
    const [firstCard, secondCard] = flipped;
    if (firstCard.dataset.emoji === secondCard.dataset.emoji) {
        setTimeout(() => {
            firstCard.classList.add("matched");
            secondCard.classList.add("matched");
            if (firstCard.dataset.emoji === 'üõ°Ô∏è') {
                showMessage(`‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ${currentPlayer} ‡¶∂‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶®‡¶≤‡¶ï ‡¶ï‡¶∞‡ßá‡¶õ‡ßá!`, true);
                if (currentPlayer === 1) p1_shieldUnlocked = true; else p2_shieldUnlocked = true;
            } else {
                if (currentPlayer === 1) { player1Score += 10; p1_consecutiveMatches++; p2_consecutiveMatches = 0; }
                else { player2Score += 10; p2_consecutiveMatches++; p1_consecutiveMatches = 0; }
            }
            flipped = []; lockBoard = false;
            updateAndSyncState();
            checkLevelComplete();
        }, 700);
    } else {
        if (currentPlayer === 1) p1_consecutiveMatches = 0; else p2_consecutiveMatches = 0;
        setTimeout(() => {
            firstCard.classList.remove("flip");
            secondCard.classList.remove("flip");
            flipped = [];
            currentPlayer = currentPlayer === 1 ? 2 : 1;
            if (isOnlineMode) isMyTurn = !isMyTurn;
            lockBoard = false;
            updateAndSyncState();
        }, 1500);
    }
}

function updateAndSyncState() {
    updateGameInfoDisplay();
    if (isOnlineMode) {
        sendData({
            type: 'state_update',
            p1Score: player1Score, p2Score: player2Score, currentPlayer: currentPlayer,
            p1_consecutive: p1_consecutiveMatches, p2_consecutive: p2_consecutiveMatches,
            p1_shieldUnlocked: p1_shieldUnlocked, p2_shieldUnlocked: p2_shieldUnlocked,
            p1_shieldActive: p1_shieldActive, p2_shieldActive: p2_shieldActive
        });
    }
}

function updateGameInfoDisplay() {
    player1ScoreElement.innerText = player1Score;
    player2ScoreElement.innerText = player2Score;
    let turnText = `‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ${currentPlayer} ‡¶è‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ`;
    if (isOnlineMode) { turnText = isMyTurn ? "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ" : "‡¶Ö‡¶®‡ßç‡¶Ø‡ßá‡¶∞ ‡¶™‡¶æ‡¶≤‡¶æ"; }
    currentPlayerElement.innerText = turnText;
    gameSizeElement.innerText = `${currentGameRows}x${currentGameCols} ‡¶¨‡ßã‡¶∞‡ßç‡¶°`;
    player1ScoreArea.classList.toggle('active-player', currentPlayer === 1);
    player2ScoreArea.classList.toggle('active-player', currentPlayer === 2);
    updatePowerUpUI();
}

function checkLevelComplete() {
    if (boardElement.querySelectorAll(".card:not(.matched)").length === 0) { endGame(); }
}

function endGame(isError = false, remoteMessage = null) {
    lockBoard = true;
    const popupMessage = document.getElementById("popup-message");
    let finalMessage = remoteMessage;
    if (!finalMessage) {
        if (isError) { finalMessage = "‡¶ó‡ßá‡¶Æ‡¶ü‡¶ø‡¶§‡ßá ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§"; }
        else if (player1Score > player2Score) { finalMessage = `‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ 1 ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá!`; }
        else if (player2Score > player1Score) { finalMessage = `‡¶™‡ßç‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ 2 ‡¶ú‡¶ø‡¶§‡ßá‡¶õ‡ßá!`; }
        else { finalMessage = "‡¶ñ‡ßá‡¶≤‡¶æ‡¶ü‡¶ø ‡¶°‡ßç‡¶∞ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!"; }
    }
    popupMessage.innerText = finalMessage;
    winPopup.classList.add('show');
    if (isOnlineMode && !remoteMessage) sendData({ type: 'game_over', message: finalMessage });
}

function resetPowerUps() { /* unchanged */ p1_consecutiveMatches=0; p2_consecutiveMatches=0; p1_penaltyCardUsed=false; p2_penaltyCardUsed=false; p1_peekCardUsed=false; p2_peekCardUsed=false; p1_shieldUnlocked=false; p2_shieldUnlocked=false; p1_shieldActive=false; p2_shieldActive=false; updatePowerUpUI(); }
function updatePowerUpUI() { /* unchanged */ p1PenaltyCard.classList.toggle('earned',p1_consecutiveMatches>=2&&!p1_penaltyCardUsed); p1PenaltyCard.classList.toggle('disabled',!(p1_consecutiveMatches>=2&&!p1_penaltyCardUsed)); p1PeekCard.classList.toggle('disabled',!(player1Score>=50&&!p1_peekCardUsed)); p2PenaltyCard.classList.toggle('earned',p2_consecutiveMatches>=2&&!p2_penaltyCardUsed); p2PenaltyCard.classList.toggle('disabled',!(p2_consecutiveMatches>=2&&!p2_penaltyCardUsed)); p2PeekCard.classList.toggle('disabled',!(player2Score>=50&&!p2_peekCardUsed)); p1ShieldCard.classList.toggle('disabled',!p1_shieldUnlocked||p1_shieldActive); p1ShieldCard.classList.toggle('earned',p1_shieldUnlocked&&!p1_shieldActive); p1ShieldCard.classList.toggle('shield-active',p1_shieldActive); p2ShieldCard.classList.toggle('disabled',!p2_shieldUnlocked||p2_shieldActive); p2ShieldCard.classList.toggle('earned',p2_shieldUnlocked&&!p2_shieldActive); p2ShieldCard.classList.toggle('shield-active',p2_shieldActive); }
function usePenaltyCard(player){ if(lockBoard||(isOnlineMode&&!isMyTurn))return; if(isOnlineMode)sendData({type:'power_up',name:'penalty',player}); applyPenalty(player);}
function applyPenalty(player){ const opponent=player===1?2:1; if(opponent===1&&p1_shieldActive){showMessage("‡¶∂‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶π‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá!",true);p1_shieldActive=false;p1_shieldUnlocked=false;}else if(opponent===2&&p2_shieldActive){showMessage("‡¶∂‡¶ø‡¶≤‡ßç‡¶° ‡¶Ü‡¶ï‡ßç‡¶∞‡¶Æ‡¶£ ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶π‡¶§ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá!",true);p2_shieldActive=false;p2_shieldUnlocked=false;}else{if(player===1){if(p1PenaltyCard.classList.contains('disabled'))return;player2Score=Math.max(0,player2Score-5);p1_penaltyCardUsed=true;p1_consecutiveMatches=0;}else{if(p2PenaltyCard.classList.contains('disabled'))return;player1Score=Math.max(0,player1Score-5);p2_penaltyCardUsed=true;p2_consecutiveMatches=0;} showMessage(`‡¶∂‡¶æ‡¶∏‡ßç‡¶§‡¶ø ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!`,true);} updateAndSyncState();}
function usePeekCard(player){ /* unchanged */ if(lockBoard||(isOnlineMode&&!isMyTurn))return; if(player===1){if(p1PeekCard.classList.contains('disabled'))return;player1Score-=50;p1_peekCardUsed=true;}else{if(p2PeekCard.classList.contains('disabled'))return;player2Score-=50;p2_peekCardUsed=true;} lockBoard=true;showMessage("‡¶∏‡¶¨ ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®!",false);updateAndSyncState();const unmatchedCards=boardElement.querySelectorAll('.card:not(.matched)');unmatchedCards.forEach(c=>c.classList.add('flip'));setTimeout(()=>{unmatchedCards.forEach(c=>{if(!flipped.includes(c))c.classList.remove('flip');});lockBoard=false;showMessage("",true);},3000);}
function useShieldCard(player){ if(lockBoard||(isOnlineMode&&!isMyTurn))return; if(player===1){if(!p1_shieldUnlocked||p1_shieldActive)return;p1_shieldActive=true;showMessage("‡¶∂‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!",true);}else{if(!p2_shieldUnlocked||p2_shieldActive)return;p2_shieldActive=true;showMessage("‡¶∂‡¶ø‡¶≤‡ßç‡¶° ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!",true);} updateAndSyncState();}

// Helper & UI Functions
function shuffle(arr){for(let i=arr.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}return arr;}
function getGridSize(rows,cols){const pairs=(rows*cols)/2;if(pairs>=maxEmojis)return null;return{totalPairs:pairs};}
function showMessage(msg,autoClear){messageElement.innerText=msg;if(autoClear)setTimeout(()=>{messageElement.innerText="";},2500);}
function showHomePage(){gameAreaElement.classList.remove('show');homepageContentElement.classList.add('show');onlineConnectionArea.style.display='none';document.getElementById('mode-selection').style.display='flex';document.getElementById('start-online-btn').style.display='block';}
function hideHomePage(){homepageContentElement.classList.remove('show');gameAreaElement.classList.add('show');}
function hideWinPopup(){winPopup.classList.remove('show');}

// --- ONLINE MULTIPLAYER LOGIC ---

function startGameOnline(rows, cols) {
    isOnlineMode = true;
    hideHomePage();
    hideWinPopup();
    resetGameState(rows, cols);
    isMyTurn = isHost;
    buildBoard(rows, cols);
    updateGameInfoDisplay();
    showMessage("‡¶Ö‡¶®‡¶≤‡¶æ‡¶á‡¶® ‡¶ó‡ßá‡¶Æ ‡¶∂‡ßÅ‡¶∞‡ßÅ!", true);
}

function sendData(data) { if (dataChannel && dataChannel.readyState === 'open') { dataChannel.send(JSON.stringify(data)); } }

async function createOnlineGame(rows, cols) {
    isHost = true;
    gameCode = Math.floor(100000 + Math.random() * 900000).toString();
    onlineCodeDisplay.innerText = `‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßã‡¶°: ${gameCode}`;
    onlineStatusElement.innerText = "‡¶Ö‡¶®‡ßç‡¶Ø ‡¶ñ‡ßá‡¶≤‡ßã‡ßü‡¶æ‡ßú‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
    peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    dataChannel = peerConnection.createDataChannel('game');
    setupDataChannelEvents();
    const gameRef = db.ref(`games/${gameCode}`);
    await gameRef.set({ offer: null, answer: null, hostCandidates: [], clientCandidates: [], rows: rows, cols: cols });
    peerConnection.onicecandidate = e => { if (e.candidate) gameRef.child('hostCandidates').push(e.candidate.toJSON()); };
    const offer = await peerConnection.createOffer();
    await peerConnection.setLocalDescription(offer);
    await gameRef.child('offer').set({ sdp: offer.sdp, type: offer.type });
    gameRef.child('answer').on('value', s => { if (s.exists() && !peerConnection.currentRemoteDescription) { peerConnection.setRemoteDescription(new RTCSessionDescription(s.val())); } });
    gameRef.child('clientCandidates').on('child_added', s => { peerConnection.addIceCandidate(new RTCIceCandidate(s.val())); });
}

async function joinOnlineGame() {
    isHost = false;
    gameCode = document.getElementById('joinCodeInput').value;
    if (!gameCode || gameCode.length !== 6) { onlineStatusElement.innerText = "‡¶∏‡¶†‡¶ø‡¶ï ‡ß¨-‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶∞ ‡¶ï‡ßã‡¶° ‡¶¶‡¶ø‡¶®‡•§"; return; }
    onlineStatusElement.innerText = `‡¶ó‡ßá‡¶Æ ${gameCode}-‡¶è ‡¶Ø‡ßã‡¶ó ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...`;
    const gameRef = db.ref(`games/${gameCode}`);
    const gameSnapshot = await gameRef.get();
    if (!gameSnapshot.exists()) { onlineStatusElement.innerText = "‡¶è‡¶á ‡¶ï‡ßã‡¶°‡ßá‡¶∞ ‡¶ï‡ßã‡¶®‡ßã ‡¶ó‡ßá‡¶Æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§"; return; }
    const { rows, cols, offer } = gameSnapshot.val();
    currentGameRows = rows; currentGameCols = cols;
    peerConnection = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });
    peerConnection.ondatachannel = e => { dataChannel = e.channel; setupDataChannelEvents(); };
    peerConnection.onicecandidate = e => { if (e.candidate) gameRef.child('clientCandidates').push(e.candidate.toJSON()); };
    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await peerConnection.createAnswer();
    await peerConnection.setLocalDescription(answer);
    await gameRef.child('answer').set({ sdp: answer.sdp, type: answer.type });
    gameRef.child('hostCandidates').on('child_added', s => { peerConnection.addIceCandidate(new RTCIceCandidate(s.val())); });
}

function setupDataChannelEvents() {
    dataChannel.onopen = () => { onlineStatusElement.innerText = "‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶°!"; db.ref(`games/${gameCode}`).remove(); startGameOnline(currentGameRows, currentGameCols); };
    dataChannel.onmessage = event => {
        const data = JSON.parse(event.data);
        switch (data.type) {
            case 'flip':
                const cardToFlip = document.querySelector(`.card[data-index="${data.index}"]`);
                if (cardToFlip) flipCard(cardToFlip, true);
                break;
            case 'state_update':
                player1Score=data.p1Score; player2Score=data.p2Score; currentPlayer=data.currentPlayer;
                p1_consecutiveMatches=data.p1_consecutive; p2_consecutiveMatches=data.p2_consecutive;
                p1_shieldUnlocked=data.p1_shieldUnlocked; p2_shieldUnlocked=data.p2_shieldUnlocked;
                p1_shieldActive=data.p1_shieldActive; p2_shieldActive=data.p2_shieldActive;
                isMyTurn = !isMyTurn;
                updateGameInfoDisplay();
                break;
            case 'power_up':
                if(data.name === 'penalty') applyPenalty(data.player);
                break;
            case 'game_over':
                endGame(false, data.message);
                break;
        }
    };
}

// Event Listeners Setup
function setupEventListeners() {
    document.querySelectorAll('#mode-selection button').forEach(b => b.addEventListener('click', () => startGame(parseInt(b.dataset.rows), parseInt(b.dataset.cols))));
    document.getElementById('start-online-btn').addEventListener('click', () => { document.getElementById('mode-selection').style.display = 'none'; document.getElementById('start-online-btn').style.display = 'none'; onlineConnectionArea.style.display = 'block'; });
    document.querySelectorAll('#online-difficulty-selection button').forEach(b => b.addEventListener('click', () => { const r=parseInt(b.dataset.rows), c=parseInt(b.dataset.cols); currentGameRows=r; currentGameCols=c; createOnlineGame(r,c); document.getElementById('online-difficulty-selection').style.display='none'; }));
    document.getElementById('join-online-btn').addEventListener('click', joinOnlineGame);
    document.getElementById('restartBtn').addEventListener('click', () => { hideWinPopup(); if(isOnlineMode){showHomePage();}else if(currentGameRows>0){startGame(currentGameRows, currentGameCols);} });
    document.getElementById('newGameBtn').addEventListener('click', () => { hideWinPopup(); showHomePage(); document.getElementById('online-difficulty-selection').style.display='flex'; onlineCodeDisplay.innerText=''; onlineStatusElement.innerText=''; document.getElementById('joinCodeInput').value=''; });
    p1PenaltyCard.addEventListener('click', () => usePenaltyCard(1)); p1PeekCard.addEventListener('click', () => usePeekCard(1)); p1ShieldCard.addEventListener('click', () => useShieldCard(1));
    p2PenaltyCard.addEventListener('click', () => usePenaltyCard(2)); p2PeekCard.addEventListener('click', () => usePeekCard(2)); p2ShieldCard.addEventListener('click', () => useShieldCard(2));
}

document.addEventListener('DOMContentLoaded', () => { showHomePage(); setupEventListeners(); });

</script>
</body>
</html>

